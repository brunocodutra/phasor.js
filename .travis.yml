language: node_js
node_js: node

git:
  depth: 1

env:
  global:
    secure: Bw4vs5JopcyYnhPfajhzbzAs2pMrF2DWoa9RZ7Q5tktcN6BbCAJXCLImphMiLTqEI9N8CFNKHdku0UgXqA17SU1UQnjWkSMVgJTG5doFfBxQYE3Ul5bCBaRNMgcg9ctVxZ8oUpb6S2hoxj+R2kisYVbWkfqK5tPA18fsGcAu7ml78hj4Jqv4vWyac2FLSrcPfePNdYJ82qfllKnZ264BAGSRVJEQIwlYc6kPAZP2GQgiXDv/waLQCKmd2Nqaa1bVB9IoYXxFB94Qto2auUgzn1pLnfJ2sESP8B4yzPqvGv6rzAVoTi/DKuolueWO2woZonaiXcCuewAA+FAkrBr1pxdR7MWhZLFrw3h2mEhUOA/XmEUhgNN37y+tD57VwIKt7sKFn4Dugs8jKZP75e+sv45HHvZ5OgTdsN5x5VMucTmFg6p647QFY6+QmemLqplkCAsqxsGJBf50sbta1L/0W4RDi+gDp/PWTZN3q9ttdHcA7Mcys45wdBwEn/GbCBaPErKM8cUGF0HzVtvi9na8R/3t5rtlcIjeODpOxwgzfcGWWGmiTtFSH8frFl9IB4m++AUZJpyMU/+nf7cOmGNwsJHBjFT9In/yAOelaUYq3byhA9c+9t/9xB/MC4kWNH6IQwgCgg/24x6GYTW5kPhw5L41xumsKSYPEbz7hr1LAc0=

jobs:
  include:
  - os: osx
    stage: test

  - os: linux
    stage: test
    after_success:
    - travis_retry npm install coveralls
    - cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js

  - stage: deploy
    script:
    - npm run build
    - npm run example
    deploy:
      provider: npm
      email: brunocodutra@gmail.com
      api_key:
        secure: RPZJm46zxsssCkGboGmUPcSgvF0TTDUCvpDx685JhHotxyTdqDimfLXzQ3Wz3rv6wytlTievjaR0fhHi/5CFQIBdbu3uo1XDxVuSq0SazQy869M7hs3oe+kZQnqTo6lIU5XqFiBE+kF0eSmEYyjFFUPfW+9UEKasNoDZ1Vj4ZsqDL6aA/RahdJkql1J1W9zqAYTdpYQqKmuGPzFn8espEi1eb7KpC9Zc1L5pDwwVKDmJNsBZFOX6VAf133qJlcdemdCI/75dNMCOZuzf+bdJEPNypaSNEI/P7GY+cqm8xUR4OLeg8pOI895dgJs2Peo+XEHUj4tbLa0chKtN6SKIZ58x9gBgIXq7ul8M5f5rg8VXkIWHw8To/2LP6gpKNP0PXXnDSdPz7CsBdMOdk8RyIeG0Auwbupbvk2aflHURoL0BCiuyQCWOKF/LhJmHU91CTObLGy2oOpWPsdfsLhQaUz0f5Z+a1f7rmDkp0cCE1YpVURuq2sDnuWqhSBxoL6+/AD2K21G1hd96AcOlNS52/bqwvFecw9Y3y/7CQNWaxpfSOhvku3IdUXysaPG6zekDdWJo6sVxCPPBz9+PXsAuUB+WhMlaexGc7Rs4Bt2zx3VCgUjY0hb+danV7LLMxwK7xiW+zkfu7z71OQjbcuktTm438iaFAT3TDToyKTaq9tE=
      skip_cleanup: true
      on:
        tags: true
        repo: brunocodutra/phasor.js

  - stage: deploy
    if: type = pull_request
    script:
    - |
      if [[ -n $(git diff --name-only package-lock.json) ]]
      then
        git config credential.helper "store --file=.git/credentials" || exit $?
        echo "https://${GH_TOKEN}:@github.com" 2> /dev/null > .git/credentials || exit $?
        git remote set-url origin https://github.com/$TRAVIS_REPO_SLUG.git || exit $?
        git add package-lock.json || exit $?
        git commit -m "update package-lock.json" || exit $?
        git push origin HEAD:$TRAVIS_PULL_REQUEST_BRANCH &> /dev/null || exit $?
      fi

before_install:
# package-lock.json was introduced in npm@5
- travis_retry npm install -g npm@latest

install:
- travis_retry npm install

before_script:
- git config --global user.name "Travis Bot"
- git config --global user.email "\<\>"

script:
- npm test
