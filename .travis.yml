language: node_js
node_js: node

git:
  depth: 1

env:
  global:
    secure: Bw4vs5JopcyYnhPfajhzbzAs2pMrF2DWoa9RZ7Q5tktcN6BbCAJXCLImphMiLTqEI9N8CFNKHdku0UgXqA17SU1UQnjWkSMVgJTG5doFfBxQYE3Ul5bCBaRNMgcg9ctVxZ8oUpb6S2hoxj+R2kisYVbWkfqK5tPA18fsGcAu7ml78hj4Jqv4vWyac2FLSrcPfePNdYJ82qfllKnZ264BAGSRVJEQIwlYc6kPAZP2GQgiXDv/waLQCKmd2Nqaa1bVB9IoYXxFB94Qto2auUgzn1pLnfJ2sESP8B4yzPqvGv6rzAVoTi/DKuolueWO2woZonaiXcCuewAA+FAkrBr1pxdR7MWhZLFrw3h2mEhUOA/XmEUhgNN37y+tD57VwIKt7sKFn4Dugs8jKZP75e+sv45HHvZ5OgTdsN5x5VMucTmFg6p647QFY6+QmemLqplkCAsqxsGJBf50sbta1L/0W4RDi+gDp/PWTZN3q9ttdHcA7Mcys45wdBwEn/GbCBaPErKM8cUGF0HzVtvi9na8R/3t5rtlcIjeODpOxwgzfcGWWGmiTtFSH8frFl9IB4m++AUZJpyMU/+nf7cOmGNwsJHBjFT9In/yAOelaUYq3byhA9c+9t/9xB/MC4kWNH6IQwgCgg/24x6GYTW5kPhw5L41xumsKSYPEbz7hr1LAc0=

jobs:
  include:
  - os: osx
    stage: test

  - os: linux
    stage: test
    after_success:
    - travis_retry npm install coveralls
    - cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js

  - stage: deploy
    script:
    - npm run build
    - npm run example
    deploy:
      provider: npm
      email: brunocodutra@gmail.com
      api_key:
        secure: rQlrCIpRNKD0uqSOVObsk5DZ/leyMjN64q2fApiN6+fg5dJWbbBdpQumLPCJmoEbqK189RuADGleeQbag/I7WU3TzYFet0baLJfR08cWYmXA8CvDsFc7Tld6GzwAhpQnKJ+cJ7uaVTKabL5kRzPnfSk1jSxahNfji51UVYosVxeGHng39lVJvUbbV0v0UGS9SFL6NH89bytc0niIkFOqLLtdAFwhR0zTVcxbVVtElPpRuuOYKhpsnRvrSyg/Qx5diLqnQ/jWhdzyicJxlqeKLsJKVeQOnBRtLz9VWw41E24+/riRyQaDJ96LEvg8t1ii+4logbGoAGEfH3oCFV5hzW0mkcbY19xT5t7bhE+tsVfTFqiWNBxD3v2kLWI5+S1vQWAQ3cmhqi3f7Dk51KHE1X+FAVcttdZApXHBCX9PRHfIULYTGntVBtReSih1L+obEK2+mZYReK8mhTaHUwjx4d/rPabAlyqDOGKFUpG9q4O5NrxjGx4GOLt3ZOCfI+S6Y5qjvYDBbc6x8LYXfKb+Q3DkCctUStFTY4h8yx3g6rnFhthui0LKgDGJTyoVjlQou72wB2ab2I0P70qPdvS6jKySXhRi0VAOcYfqvMpdsWfursi31PvDZ4LCLPh/eT63S8SIy8sJWpRB0otOAvfOBRTfuWt1IYKA4lm3dE5wtD8=
      skip_cleanup: true
      on:
        tags: true
        repo: brunocodutra/phasor.js

  - stage: deploy
    if: type = pull_request
    script:
    - |
      if [[ -n $(git diff --name-only package-lock.json) ]]
      then
        git config credential.helper "store --file=.git/credentials" || exit $?
        echo "https://${GH_TOKEN}:@github.com" 2> /dev/null > .git/credentials || exit $?
        git remote set-url origin https://github.com/$TRAVIS_REPO_SLUG.git || exit $?
        git add package-lock.json || exit $?
        git commit -m "update package-lock.json" || exit $?
        git push origin HEAD:$TRAVIS_PULL_REQUEST_BRANCH &> /dev/null || exit $?
      fi

install:
- travis_retry npm install

before_script:
- git config --global user.name "Travis Bot"
- git config --global user.email "\<\>"

script:
- npm test
